blueprint:
  name: Dim Up and Down Light with Steps
  description: >
    Dim up and dim down a light with specified steps. Turn off the light when brightness is at 0 and dim down. Turn on the light when it's off and dim up.
  domain: automation
  input:
    light_entity:
      name: Light Entity
      description: The light entity to control
      selector:
        entity:
          domain: light
    dim_up_device:
      name: Dim Up Device
      description: Device to trigger dim up action
      selector:
        device:
    dim_down_device:
      name: Dim Down Device
      description: Device to trigger dim down action
      selector:
        device:
    dim_step:
      name: Dim Step
      description: The amount of brightness to change per step (0-255)
      default: 51
      selector:
        number:
          min: 1
          max: 255
          unit_of_measurement: brightness
          mode: slider

variables:
  light_entity: !input light_entity
  dim_step: !input dim_step

trigger:
  - platform: device
    device_id: !input dim_up_device
    domain: automation
    type: execute
    subtype: dim_up
  - platform: device
    device_id: !input dim_down_device
    domain: automation
    type: execute
    subtype: dim_down

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'device' and trigger.device_id == dim_up_device }}"
        sequence:
          - service: light.turn_on
            data_template:
              entity_id: !input light_entity
              brightness: >
                {% set current_brightness = state_attr(light_entity, 'brightness') | int %}
                {% if current_brightness is none %}
                  {{ dim_step }}
                {% else %}
                  {% set new_brightness = current_brightness + dim_step %}
                  {{ new_brightness if new_brightness <= 255 else 255 }}
                {% endif %}
      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'device' and trigger.device_id == dim_down_device }}"
        sequence:
          - service: light.turn_on
            data_template:
              entity_id: !input light_entity
              brightness: >
                {% set current_brightness = state_attr(light_entity, 'brightness') | int %}
                {% if current_brightness is none or current_brightness == 0 %}
                  0
                {% else %}
                  {% set new_brightness = current_brightness - dim_step %}
                  {{ new_brightness if new_brightness >= 0 else 0 }}
                {% endif %}
          - condition: template
            value_template: "{{ state_attr(light_entity, 'brightness') == 0 }}"
            sequence:
              - service: light.turn_off
                data:
                  entity_id: !input light_entity
